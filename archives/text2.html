<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>【转载】Android 外置 SD 卡写入权限问题 | GoodGuy&#39;blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content>
    <meta name="description" content="最近升级到 Android 9.0 后，发现文件管理器在写入外置 SD 卡时出现了写入失败的问题，定位到 File.canWrite() 方法，发现返回了 false。经过讨论追踪定位，发现是由于 Google 的一个更改导致的: diff --git a/data/etc/platform.xml b/data/etc/platform.xml index 04006b1..3021555 10">
<meta property="og:type" content="article">
<meta property="og:title" content="【转载】Android 外置 SD 卡写入权限问题">
<meta property="og:url" content="http://goodguy.cc/archives/text2.html">
<meta property="og:site_name" content="GoodGuy&#39;blog">
<meta property="og:description" content="最近升级到 Android 9.0 后，发现文件管理器在写入外置 SD 卡时出现了写入失败的问题，定位到 File.canWrite() 方法，发现返回了 false。经过讨论追踪定位，发现是由于 Google 的一个更改导致的: diff --git a/data/etc/platform.xml b/data/etc/platform.xml index 04006b1..3021555 10">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://busy.im/img/sdoperatestep.png">
<meta property="og:image" content="https://busy.im/img/screenshot2018-12-25-20-45-12.png">
<meta property="og:updated_time" content="2019-10-01T04:29:19.732Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【转载】Android 外置 SD 卡写入权限问题">
<meta name="twitter:description" content="最近升级到 Android 9.0 后，发现文件管理器在写入外置 SD 卡时出现了写入失败的问题，定位到 File.canWrite() 方法，发现返回了 false。经过讨论追踪定位，发现是由于 Google 的一个更改导致的: diff --git a/data/etc/platform.xml b/data/etc/platform.xml index 04006b1..3021555 10">
<meta name="twitter:image" content="https://busy.im/img/sdoperatestep.png">
    
        <link rel="alternate" type="application/atom+xml" title="GoodGuy&#39;blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">GoodGuy</h5>
          <a href="mailto:2560861029@qq.com" title="2560861029@qq.com" class="mail">2560861029@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect active">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/q012306" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://weibo.com/3207855562" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                微博
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://q012306.xicp.net/" target="_blank" >
                <i class="icon icon-lg icon-我的树莓派"></i>
                我的树莓派
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于我
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">【转载】Android 外置 SD 卡写入权限问题</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">【转载】Android 外置 SD 卡写入权限问题</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-10-01T04:24:09.000Z" itemprop="datePublished" class="page-time">
  2019-10-01
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#平台签名应用受影响"><span class="post-toc-number">1.</span> <span class="post-toc-text">平台签名应用受影响</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DocumentFile-适配方案"><span class="post-toc-number">2.</span> <span class="post-toc-text">DocumentFile 适配方案</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-请求写入外置-SD-卡权限"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1. 请求写入外置 SD 卡权限</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-DocumentFile-文件操作封装"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2. DocumentFile 文件操作封装</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">3.</span> <span class="post-toc-text">参考</span></a></li></ol>
        </nav>
    </aside>


<article id="post-text2"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">【转载】Android 外置 SD 卡写入权限问题</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-10-01 12:24:09" datetime="2019-10-01T04:24:09.000Z"  itemprop="datePublished">2019-10-01</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>最近升级到 Android 9.0 后，发现文件管理器在写入外置 SD 卡时出现了写入失败的问题，定位到 <code>File.canWrite()</code> 方法，发现返回了 <code>false</code>。经过讨论追踪定位，发现是由于 Google 的一个<a href="https://android.googlesource.com/platform/frameworks/base/+/86684240eb5753bb97c2cfc93d1d25fa1870f8f1%5E%21/#F1" target="_blank" rel="noopener">更改</a>导致的:</p>
<pre><code>diff --git a/data/etc/platform.xml b/data/etc/platform.xml
index 04006b1..3021555 100644
--- a/data/etc/platform.xml
+++ b/data/etc/platform.xml
@@ -62,7 +62,6 @@

     &lt;permission name=&quot;android.permission.WRITE_MEDIA_STORAGE&quot; &gt;
         &lt;group gid=&quot;media_rw&quot; /&gt;
-        &lt;group gid=&quot;sdcard_rw&quot; /&gt;
     &lt;/permission&gt;

     &lt;permission name=&quot;android.permission.ACCESS_MTP&quot; &gt;


diff --git a/services/core/java/com/android/server/pm/PackageManagerService.java b/services/core/java/com/android/server/pm/PackageManagerService.java
index a0cb722..940d19f 100644
--- a/services/core/java/com/android/server/pm/PackageManagerService.java
+++ b/services/core/java/com/android/server/pm/PackageManagerService.java
@@ -20936,9 +20936,6 @@
                 if (Process.isIsolated(uid)) {
                     return Zygote.MOUNT_EXTERNAL_NONE;
                 }
-                if (checkUidPermission(WRITE_MEDIA_STORAGE, uid) == PERMISSION_GRANTED) {
-                    return Zygote.MOUNT_EXTERNAL_DEFAULT;
-                }
                 if (checkUidPermission(READ_EXTERNAL_STORAGE, uid) == PERMISSION_DENIED) {
                     return Zygote.MOUNT_EXTERNAL_DEFAULT;
                 }
</code></pre><p>这里的修改移除了 <code>WRITE_MEDIA_STORAGE</code> 权限相关权限，导致了外部 SD 卡存储不可写的问题。</p>
<h2 id="平台签名应用受影响"><a href="#平台签名应用受影响" class="headerlink" title="平台签名应用受影响"></a><a href="#平台签名应用受影响" title="平台签名应用受影响"></a>平台签名应用受影响</h2><p>这个修改对系统应用影响较大，在 9.0 之前的平台，申请了 <code>WRITE_MEDIA_STORAGE</code> 的权限后，平台签名的应用就可以通过 <code>java.io.File</code> 接口写入外置 SD 卡了。但是这个修改之后，想要写入外置 SD 卡，就需要像第三方应用一样，使用 <code>DocumentFile</code> 的接口，可以阅读 API 文档 <a href="https://developer.android.com/guide/topics/providers/document-provider?hl=zh-cn" target="_blank" rel="noopener">存储访问框架</a> 和 <a href="https://developer.android.com/training/articles/scoped-directory-access?hl=zh-cn" target="_blank" rel="noopener">使用作用域目录访问</a> 。</p>
<p>参考 google 的这个 <a href="https://issuetracker.google.com/issues/113498210" target="_blank" rel="noopener">bug</a> ，平台类的应用，如文件管理器、相机、图库甚至 MediaProvider 都会出现外置 SD 卡只能读不可写，即写入失败的问题，因为这些系统应用都没有适配 <code>DocumentProvider</code> 的写入方式。</p>
<h2 id="DocumentFile-适配方案"><a href="#DocumentFile-适配方案" class="headerlink" title="DocumentFile 适配方案"></a><a href="#documentfile-适配方案" title="DocumentFile 适配方案"></a>DocumentFile 适配方案</h2><h3 id="1-请求写入外置-SD-卡权限"><a href="#1-请求写入外置-SD-卡权限" class="headerlink" title="1. 请求写入外置 SD 卡权限"></a><a href="#1-请求写入外置-sd-卡权限" title="1. 请求写入外置 SD 卡权限"></a>1. 请求写入外置 SD 卡权限</h3><p>早在 Android 4.4，Android 就已经加入了存储访问框架，外置 SD 卡的访问由 DocumentsUI (com.android.documentsui) 提供支持，经过 5.0 版本的完善以及 7.0 的改进，目前有两种请求外置 SD 卡写入权限的交互方法：</p>
<ul>
<li>Android 7.0 之前，使用 ACTION_OPEN_DOCUMENT_TREE 跳转到 DocumentsUI 的存储选择界面，之后用户手动打开外置存储并选择</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://busy.im/img/sdoperatestep.png" alt="手动选择 sd 卡提示" title>
                </div>
                <div class="image-caption">手动选择 sd 卡提示</div>
            </figure>
<ul>
<li>Android 7.0 及之后，使用 <a href="https://developer.android.com/reference/android/os/storage/StorageVolume#createAccessIntent(java.lang.String" target="_blank" rel="noopener">StorageVolume.createAccessIntent(null)</a>) 跳转到权限写入提示框。(这个提示框也是 DocumentsUI 提供的，只是对之前的交互做了改进，避免繁琐的用户操作)</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://busy.im/img/screenshot2018-12-25-20-45-12.png" alt="新的权限提示框" title>
                </div>
                <div class="image-caption">新的权限提示框</div>
            </figure>
<p>检查权限界面的属性，会发现这个权限提示框其实是 <code>com.android.documentsui/com.android.documentsui.ScopedAccessActivity</code></p>
<p>也就是说 DocumentsUI 为了简化权限请求的流程，已经特意做了一个权限的提示框。</p>
<p>而 <a href="https://developer.android.com/reference/android/os/storage/StorageVolume#createAccessIntent(java.lang.String" target="_blank" rel="noopener">StorageVolume.createAccessIntent(String directoryName)</a>) 可以传入众多媒体类型，包括音乐、图片、电影、文档等，如果传入参数为 <code>null</code> ，则表示整个外置存储分区。</p>
<p>Parameters</p>
<p><code>directoryName</code></p>
<p><code>String</code>: must be one of <code>Environment.DIRECTORY_MUSIC</code>, <code>Environment.DIRECTORY_PODCASTS</code>, <code>Environment.DIRECTORY_RINGTONES</code>, <code>Environment.DIRECTORY_ALARMS</code>, <code>Environment.DIRECTORY_NOTIFICATIONS</code>, <code>Environment.DIRECTORY_PICTURES</code>, <code>Environment.DIRECTORY_MOVIES</code>, <code>Environment.DIRECTORY_DOWNLOADS</code>, <code>Environment.DIRECTORY_DCIM</code>, or <code>Environment.DIRECTORY_DOCUMENTS</code>, or <code>null</code> to request access to the entire volume.</p>
<p>Returns</p>
<p><code>Intent</code></p>
<p>intent to request access, or <code>null</code> if the requested directory is invalid for that volume.</p>
<p><strong>权限请求及处理</strong></p>
<p>权限请求需要在 Activity 或者 Fragment 中发起，同时在 <code>onActivityResult</code> 中捕获返回的 <code>Uri</code>，这个 <code>Uri</code> 可以保存在本地存储中，方便再次调用。请求的代码封装如下：</p>
<pre><code>@Override
public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    // ...
    if (DocumentsUtils.checkWritableRootPath(getActivity(), rootPath)) {
        showOpenDocumentTree();
    }
    // ...
}

private void showOpenDocumentTree() {
    Intent intent = null;
    if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.N) {
        StorageManager sm = getActivity().getSystemService(StorageManager.class);

        StorageVolume volume = sm.getStorageVolume(new File(rootPath));

        if (volume != null) {
            intent = volume.createAccessIntent(null);
        }
    }

    if (intent == null) {
        intent = new Intent(Intent.ACTION_OPEN_DOCUMENT_TREE);
    }
    startActivityForResult(intent, DocumentsUtils.OPEN_DOCUMENT_TREE_CODE);
}

@Override
public void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    switch (requestCode) {
        case DocumentsUtils.OPEN_DOCUMENT_TREE_CODE:
            if (data != null &amp;&amp; data.getData() != null) {
                Uri uri = data.getData();
                DocumentsUtils.saveTreeUri(getActivity(), rootPath, uri);
            }
            break;
        default:
            break;
    }
}
</code></pre><p>这里的 <code>rootPath</code> 是上下文中传入的外置 sd 卡根目录，如 <code>/storage/0000-0000</code> 这样的路径，可以通过 <code>context.getExternalFilesDirs(&quot;external&quot;)</code> 方法获取到。<code>DocumentsUtils</code> 工具类的实现方法见下文。</p>
<p>其中 <code>DocumentsUtils.checkWritableRootPath()</code> 方法用来检查 SD 卡根目录是否有写入权限，如果没有则跳转到权限请求；<code>DocumentsUtils.saveTreeUri()</code> 方法保存返回的 <code>Uri</code> 信息到本地存储，以便之后查询。</p>
<h3 id="2-DocumentFile-文件操作封装"><a href="#2-DocumentFile-文件操作封装" class="headerlink" title="2. DocumentFile 文件操作封装"></a><a href="#2-documentfile-文件操作封装" title="2. DocumentFile 文件操作封装"></a>2. DocumentFile 文件操作封装</h3><p>由于之前应用使用了 <code>java.io.File</code> 接口操作外置 SD 卡文件，期望对代码的修改量最小，则最好的方式是对已有的 <code>File</code> 操作再做一次封装。</p>
<p>由于 Android 9.0 之前系统应用默认是可以通过 <code>java.io.File</code> 接口写入外置 SD卡 的，而如果作为公开市场第三方应用却在 4.4 之后就不可写，而且有的厂商定制版本 Android 9.0 外置 SD 卡也是可以直接写入而不需要 DocumentFile 接口，DocumentFile 接口也没有 <code>java.io.File</code> 效率高。</p>
<p><strong>所以最好的办法是先检查是否有文件写入权限，如果有写入权限，则直接使用 File 接口操作，如果没有权限再检查文件是否在外置 SD 卡，如果文件在 SD 卡则使用 DocumentFile 接口操作。</strong></p>
<p>封装的工具类 <code>DocumentsUtils</code> 方法说明，<strong>不兼容</strong> 表示没有封装 DocumentFile 操作：</p>
<p>DocumentsUtils 公共方法</p>
<p>功能描述</p>
<p>void cleanCache()</p>
<p>清除路径缓存，建议插拔 sd 卡后调用</p>
<p>boolean isOnExtSdCard(File file, Context c)</p>
<p>文件路径是否在外置 SD 卡上</p>
<p>DocumentFile getDocumentFile(final File file, final boolean isDirectory, Context context)</p>
<p>从 File 转到 DocumentFile</p>
<p>boolean mkdirs(Context context, File dir)</p>
<p>创建文件夹</p>
<p>boolean delete(Context context, File file)</p>
<p>删除文件</p>
<p>boolean canWrite(File file)</p>
<p>File 文件是否可写（如果文件不存在，则尝试创建文件再删除检查写入权限）<strong>不兼容</strong></p>
<p>boolean canWrite(Context context, File file)</p>
<p>文件是否可写</p>
<p>boolean renameTo(Context context, File src, File dest)</p>
<p>文件重命名</p>
<p>boolean saveTreeUri(Context context, String rootPath, Uri uri)</p>
<p>保存 path 和 uri 到本地存储</p>
<p>boolean checkWritableRootPath(Context context, String rootPath)</p>
<p>检查路径是否可写，不可写返回 true</p>
<p>InputStream getInputStream(Context context, File destFile)</p>
<p>获取 InputStream，可用于读操作</p>
<p>OutputStream getOutputStream(Context context, File destFile)</p>
<p>获取 OutputStream，可用于写操作</p>
<p>封装的工具类 <code>DocumentsUtils.java</code> 内容如下：</p>
<pre><code>public class DocumentsUtils {

    private static final String TAG = DocumentsUtils.class.getSimpleName();

    public static final int OPEN_DOCUMENT_TREE_CODE = 8000;

    private static List&lt;String&gt; sExtSdCardPaths = new ArrayList&lt;&gt;();

    private DocumentsUtils() {

    }

    public static void cleanCache() {
        sExtSdCardPaths.clear();
    }

    /**
     * Get a list of external SD card paths. (Kitkat or higher.)
     *
     * @return A list of external SD card paths.
     */
    @TargetApi(Build.VERSION_CODES.KITKAT)
    private static String[] getExtSdCardPaths(Context context) {
        if (sExtSdCardPaths.size() &gt; 0) {
            return sExtSdCardPaths.toArray(new String[0]);
        }
        for (File file : context.getExternalFilesDirs(&quot;external&quot;)) {
            if (file != null &amp;&amp; !file.equals(context.getExternalFilesDir(&quot;external&quot;))) {
                int index = file.getAbsolutePath().lastIndexOf(&quot;/Android/data&quot;);
                if (index &lt; 0) {
                    Log.w(TAG, &quot;Unexpected external file dir: &quot; + file.getAbsolutePath());
                } else {
                    String path = file.getAbsolutePath().substring(0, index);
                    try {
                        path = new File(path).getCanonicalPath();
                    } catch (IOException e) {
                        // Keep non-canonical path.
                    }
                    sExtSdCardPaths.add(path);
                }
            }
        }
        if (sExtSdCardPaths.isEmpty()) sExtSdCardPaths.add(&quot;/storage/sdcard1&quot;);
        return sExtSdCardPaths.toArray(new String[0]);
    }

    /**
     * Determine the main folder of the external SD card containing the given file.
     *
     * @param file the file.
     * @return The main folder of the external SD card containing this file, if the file is on an SD
     * card. Otherwise,
     * null is returned.
     */
    @TargetApi(Build.VERSION_CODES.KITKAT)
    private static String getExtSdCardFolder(final File file, Context context) {
        String[] extSdPaths = getExtSdCardPaths(context);
        try {
            for (int i = 0; i &lt; extSdPaths.length; i++) {
                if (file.getCanonicalPath().startsWith(extSdPaths[i])) {
                    return extSdPaths[i];
                }
            }
        } catch (IOException e) {
            return null;
        }
        return null;
    }

    /**
     * Determine if a file is on external sd card. (Kitkat or higher.)
     *
     * @param file The file.
     * @return true if on external sd card.
     */
    @TargetApi(Build.VERSION_CODES.KITKAT)
    public static boolean isOnExtSdCard(final File file, Context c) {
        return getExtSdCardFolder(file, c) != null;
    }

    /**
     * Get a DocumentFile corresponding to the given file (for writing on ExtSdCard on Android 5).
     * If the file is not
     * existing, it is created.
     *
     * @param file        The file.
     * @param isDirectory flag indicating if the file should be a directory.
     * @return The DocumentFile
     */
    public static DocumentFile getDocumentFile(final File file, final boolean isDirectory,
            Context context) {

        if (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.KITKAT) {
            return DocumentFile.fromFile(file);
        }

        String baseFolder = getExtSdCardFolder(file, context);
        boolean originalDirectory = false;
        if (baseFolder == null) {
            return null;
        }

        String relativePath = null;
        try {
            String fullPath = file.getCanonicalPath();
            if (!baseFolder.equals(fullPath)) {
                relativePath = fullPath.substring(baseFolder.length() + 1);
            } else {
                originalDirectory = true;
            }
        } catch (IOException e) {
            return null;
        } catch (Exception f) {
            originalDirectory = true;
            //continue
        }
        String as = PreferenceManager.getDefaultSharedPreferences(context).getString(baseFolder,
                null);

        Uri treeUri = null;
        if (as != null) treeUri = Uri.parse(as);
        if (treeUri == null) {
            return null;
        }

        // start with root of SD card and then parse through document tree.
        DocumentFile document = DocumentFile.fromTreeUri(context, treeUri);
        if (originalDirectory) return document;
        String[] parts = relativePath.split(&quot;/&quot;);
        for (int i = 0; i &lt; parts.length; i++) {
            DocumentFile nextDocument = document.findFile(parts[i]);

            if (nextDocument == null) {
                if ((i &lt; parts.length - 1) || isDirectory) {
                    nextDocument = document.createDirectory(parts[i]);
                } else {
                    nextDocument = document.createFile(&quot;image&quot;, parts[i]);
                }
            }
            document = nextDocument;
        }

        return document;
    }

    public static boolean mkdirs(Context context, File dir) {
        boolean res = dir.mkdirs();
        if (!res) {
            if (DocumentsUtils.isOnExtSdCard(dir, context)) {
                DocumentFile documentFile = DocumentsUtils.getDocumentFile(dir, true, context);
                res = documentFile != null &amp;&amp; documentFile.canWrite();
            }
        }
        return res;
    }

    public static boolean delete(Context context, File file) {
        boolean ret = file.delete();

        if (!ret &amp;&amp; DocumentsUtils.isOnExtSdCard(file, context)) {
            DocumentFile f = DocumentsUtils.getDocumentFile(file, false, context);
            if (f != null) {
                ret = f.delete();
            }
        }
        return ret;
    }

    public static boolean canWrite(File file) {
        boolean res = file.exists() &amp;&amp; file.canWrite();

        if (!res &amp;&amp; !file.exists()) {
            try {
                if (!file.isDirectory()) {
                    res = file.createNewFile() &amp;&amp; file.delete();
                } else {
                    res = file.mkdirs() &amp;&amp; file.delete();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return res;
    }

    public static boolean canWrite(Context context, File file) {
        boolean res = canWrite(file);

        if (!res &amp;&amp; DocumentsUtils.isOnExtSdCard(file, context)) {
            DocumentFile documentFile = DocumentsUtils.getDocumentFile(file, true, context);
            res = documentFile != null &amp;&amp; documentFile.canWrite();
        }
        return res;
    }

    public static boolean renameTo(Context context, File src, File dest) {
        boolean res = src.renameTo(dest);

        if (!res &amp;&amp; isOnExtSdCard(dest, context)) {
            DocumentFile srcDoc;
            if (isOnExtSdCard(src, context)) {
                srcDoc = getDocumentFile(src, false, context);
            } else {
                srcDoc = DocumentFile.fromFile(src);
            }
            DocumentFile destDoc = getDocumentFile(dest.getParentFile(), true, context);
            if (srcDoc != null &amp;&amp; destDoc != null) {
                try {
                    if (src.getParent().equals(dest.getParent())) {
                        res = srcDoc.renameTo(dest.getName());
                    } else if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) {
                        res = DocumentsContract.moveDocument(context.getContentResolver(),
                                srcDoc.getUri(),
                                srcDoc.getParentFile().getUri(),
                                destDoc.getUri()) != null;
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }

        return res;
    }

    public static InputStream getInputStream(Context context, File destFile) {
        InputStream in = null;
        try {
            if (!canWrite(destFile) &amp;&amp; isOnExtSdCard(destFile, context)) {
                DocumentFile file = DocumentsUtils.getDocumentFile(destFile, false, context);
                if (file != null &amp;&amp; file.canWrite()) {
                    in = context.getContentResolver().openInputStream(file.getUri());
                }
            } else {
                in = new FileInputStream(destFile);

            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        return in;
    }

    public static OutputStream getOutputStream(Context context, File destFile) {
        OutputStream out = null;
        try {
            if (!canWrite(destFile) &amp;&amp; isOnExtSdCard(destFile, context)) {
                DocumentFile file = DocumentsUtils.getDocumentFile(destFile, false, context);
                if (file != null &amp;&amp; file.canWrite()) {
                    out = context.getContentResolver().openOutputStream(file.getUri());
                }
            } else {
                out = new FileOutputStream(destFile);

            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        return out;
    }

    public static boolean saveTreeUri(Context context, String rootPath, Uri uri) {
        DocumentFile file = DocumentFile.fromTreeUri(context, uri);
        if (file != null &amp;&amp; file.canWrite()) {
            SharedPreferences perf = PreferenceManager.getDefaultSharedPreferences(context);
            perf.edit().putString(rootPath, uri.toString()).apply();
            return true;
        } else {
            Log.e(TAG, &quot;no write permission: &quot; + rootPath);
        }
        return false;
    }

    public static boolean checkWritableRootPath(Context context, String rootPath) {
        File root = new File(rootPath);
        if (!root.canWrite()) {

            if (DocumentsUtils.isOnExtSdCard(root, context)) {
                DocumentFile documentFile = DocumentsUtils.getDocumentFile(root, true, context);
                return documentFile == null || !documentFile.canWrite();
            } else {
                SharedPreferences perf = PreferenceManager.getDefaultSharedPreferences(context);

                String documentUri = perf.getString(rootPath, &quot;&quot;);

                if (documentUri == null || documentUri.isEmpty()) {
                    return true;
                } else {
                    DocumentFile file = DocumentFile.fromTreeUri(context, Uri.parse(documentUri));
                    return !(file != null &amp;&amp; file.canWrite());
                }
            }
        }
        return false;
    }
}
</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a><a href="#参考" title="参考"></a>参考</h2><p><a href="https://android.googlesource.com/platform/frameworks/base/+/86684240eb5753bb97c2cfc93d1d25fa1870f8f1%5E%21/#F1" target="_blank" rel="noopener">Media process should run with “write” access.</a></p>
<p><a href="https://issuetracker.google.com/issues/113498210" target="_blank" rel="noopener">[Developer Preview Android P]WRITE_MEDIA_STORAGE is not working for system apps to access the secondary storage.</a></p>
<p><a href="https://github.com/TeamAmaze/AmazeFileManager/blob/master/app/src/main/java/com/amaze/filemanager/filesystem/FileUtil.java" target="_blank" rel="noopener">AmazeFileManager/FileUtil.java</a></p>
<blockquote>
<p>原文：<a href="https://busy.im/post/android-sdcard-write/" target="_blank" rel="noopener">https://busy.im/post/android-sdcard-write/</a></p>
</blockquote>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-10-01T04:29:19.732Z" itemprop="dateUpdated">2019-10-01 12:29:19</time>
</span><br>


        
        本文地址：<a href="/archives/text2.html" target="_blank" rel="external">http://goodguy.cc/archives/text2.html</a>
        
    </div>
    
    <footer>
        <a href="http://goodguy.cc">
            <img src="/img/avatar.jpg" alt="GoodGuy">
            GoodGuy
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://goodguy.cc/archives/text2.html&title=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&pic=http://goodguy.cc/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://goodguy.cc/archives/text2.html&title=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&source=低调做人,低调做事.咸鱼虽寿,犹有竟时." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://goodguy.cc/archives/text2.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&url=http://goodguy.cc/archives/text2.html&via=http://goodguy.cc" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://goodguy.cc/archives/text2.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/archives/text1.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">【转载】ANDROID中调用文件管理器并返回选中文件的路径</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>GoodGuy &copy; 2017 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://goodguy.cc/archives/text2.html&title=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&pic=http://goodguy.cc/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://goodguy.cc/archives/text2.html&title=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&source=低调做人,低调做事.咸鱼虽寿,犹有竟时." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://goodguy.cc/archives/text2.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《【转载】Android 外置 SD 卡写入权限问题》 — GoodGuy'blog&url=http://goodguy.cc/archives/text2.html&via=http://goodguy.cc" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://goodguy.cc/archives/text2.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABz0lEQVR42u3aS3LDIBAFQN//0soBHOH3wBBVqlm5FBs1WUwxn9crXtfben9+92S852vHwsXFXeZewzVmJa+/22f8/PbYuLi4B7nJa5Kt746R/DuiYIeLi/tIbh6kkgPj4uL+J+74V0k6hIuL+3zuXBgaF0Hy4LUlV8PFxV3g5lXKfZ+31HdxcXGnuFe52oONn9Rvx8XFPcLNA8pKK6W9GI3fi4uLu5s7dxFJCiKTJY/hPri4uGe40Z+nWintVaYojuDi4h7ktleZvFmSsIrrFC4u7gO4OTQPUnk6VAcyXFzcZe56cTNJkJLxi2gsAxcX9yA3uXwUcbFsqyRFmV86P7i4uNu4yVWj2Gj5GlQkP7i4uNu47Rbt8NbKYT7EXVxc3G3cPHVpk5x8wKId88LFxf1bbo7Of9UOdhSBDBcXdwO3LXmsXFzysc6obIqLi7uNmyQ5df+2TJ+ib+Li4m7mXuXa0Zot0iRcXNwj3LY80W6aF2HzhAoXF/cMtw1e7YuTQkkSCnFxcc9zv5UUrYfCusmKi4v7AO56yyQpqn4ojuDi4j6M27Zm18cyvhB3cXFxp7jt6ORc03RuCAwXF/c8tw0lc4f5kNLEO+Pi4m7m/gBaQrlof27S/wAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '(つェ⊂)看不见。';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ0)咦!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
